from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
import os
import requests
import json
import re
from dotenv import load_dotenv


# ==================== LOAD ENV ====================
load_dotenv()
GEMINI_API_KEY = os.getenv("GEMINI_API_KEY")
print(f"üöÄ GEMINI KEY: {'‚úÖ LOADED' if GEMINI_API_KEY else '‚ùå MISSING'}")


# ==================== APP SETUP ====================
app = FastAPI(title="AI Urban Hybrid Agent")

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)


# ==================== MODELS ====================
class IssueRequest(BaseModel):
    issue_text: str


# ==================== HELPER FUNCTIONS ====================
def format_result(issue_type, impact_area, priority, actions, emergency_numbers):
    return {
        "Issue Type": issue_type,
        "Impact Area": impact_area,
        "Priority Score": f"{priority} / 10",
        "Action Plan": actions[:3],
        "Estimated Risk Reduction": "High" if priority >= 8 else "Medium",
        "Emergency Numbers to Call": emergency_numbers
    }


# ==================== RULE-BASED FALLBACK ====================
def rule_based_fallback(text: str):
    text = text.lower()
    results = []

    intents = [
    {
        "name": "Crime / Personal Safety",
        "keywords": ["rape", "sexual assault", "harassment", "attacking", "attack", "kill", "murder"],
        "impact_area": ["Victim", "Public"],
        "priority": 10,
        "actions": [
            "Ensure victim safety",
            "Alert authorities immediately",
            "Stay nearby to provide support"
        ],
        "emergency_numbers": {"Police": "100", "Women Helpline": "1091"}
    },
    {
        "name": "Fire / Emergency / Injury",
        "keywords": ["fire", "injury", "emergency"],
        "impact_area": ["Public"],
        "priority": 10,
        "actions": [
            "Evacuate people to a safe distance",
            "Avoid dangerous area",
            "Alert emergency responders"
        ],
        "emergency_numbers": {"Fire Brigade": "101", "Ambulance": "108", "Police": "100"}
    },
    {
        "name": "Road Accident",
        "keywords": ["accident", "collision", "crash"],
        "impact_area": ["Victims", "Traffic"],
        "priority": 10,
        "actions": [
            "Ensure safety of injured persons",
            "Do not move victims unless required",
            "Call emergency services immediately"
        ],
        "emergency_numbers": {"Ambulance": "108", "Police": "100"}
    },
    {
        "name": "Traffic / Safety",
        "keywords": ["traffic", "jam", "signal", "congestion"],
        "impact_area": ["Commuters"],
        "priority": 9,
        "actions": [
            "Follow traffic police instructions",
            "Avoid unnecessary honking",
            "Use alternative routes if possible"
        ],
        "emergency_numbers": {"Traffic Police": "103"}
    },
    {
        "name": "Construction / Noise",
        "keywords": ["construction", "noise", "dust", "building"],
        "impact_area": ["Residents"],
        "priority": 6,
        "actions": [
            "Avoid affected area if possible",
            "Report to local authorities",
            "Request noise control measures"
        ],
        "emergency_numbers": {"Municipal Corporation": "1916"}
    },
    {
        "name": "Garbage / Waste Management",
        "keywords": ["garbage", "waste", "trash", "rubbish", "dump", "litter", "dumping"],
        "impact_area": ["Environment", "Public Health"],
        "priority": 5,
        "actions": [
            "Report to waste management authority",
            "Do not dispose trash improperly",
            "Request regular garbage collection"
        ],
        "emergency_numbers": {"Municipal Corporation": "1916", "Waste Management": "1969"}
    },
    {
        "name": "Toilet / Sanitation Issue",
        "keywords": ["toilet", "sanitation", "sewer", "drainage", "bathroom", "restroom", "latrine"],
        "impact_area": ["Public", "Health"],
        "priority": 7,
        "actions": [
            "Report to municipal authority immediately",
            "Avoid contaminated area",
            "Request maintenance and repair"
        ],
        "emergency_numbers": {"Municipal Corporation": "1916", "Health Department": "104"}
    },
    {
        "name": "Waterlogging / Flooding",
        "keywords": ["waterlogging", "flooding", "water", "wet", "rain", "stagnant", "drain"],
        "impact_area": ["Roads", "Residents", "Traffic"],
        "priority": 8,
        "actions": [
            "Avoid waterlogged area",
            "Report to municipal authority",
            "Request drainage system repair"
        ],
        "emergency_numbers": {"Municipal Corporation": "1916", "Disaster Management": "1070"}
    }
]

    

    for intent in intents:
        if any(word in text for word in intent["keywords"]):
            results.append(
                format_result(
                    intent["name"],
                    intent["impact_area"],
                    intent["priority"],
                    intent["actions"],
                    intent["emergency_numbers"]
                )
            )

    if not results:
        results.append(
            format_result(
                "Unrecognized Issue",
                ["General"],
                0,
                [
                    "Describe your civic problem more specifically",
                    "Examples: garbage, waterlogging, traffic, police help", 
                    "Try again with details for accurate assistance"
                ],
                {"Municipal Helpline": "1916", "Any Emergency": "112"}
            )
        )

    return results



# ==================== GEMINI AI ====================
# ... (Baaki imports aur setup wahi rahega)

def gemini_analysis(text: str):
    if not GEMINI_API_KEY:
        print("‚ùå GEMINI_API_KEY missing")
        raise Exception("Gemini API key missing")

    url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key={GEMINI_API_KEY}"
    
    headers = {'Content-Type': 'application/json'}
    
    prompt = f"""
    Analyze the users issue and respond accurately according to their situation
    INDIA PUNE EMERGENCY NUMBERS ONLY (NEVER use 911/US numbers):
Police: 100/112 | Fire: 101 | Ambulance: 108 | Municipal: 1916

Analyze civic issue: "{text}"
Output ONLY JSON array with CORRECT Indian numbers:

[
  {{
    "Issue Type": "Garbage Management",
    "Impact Area": ["Public Health"], 
    "Priority Score": "6 / 10",
    "Action Plan": ["Try to maintain distance", "Report online", "Avoid area"],
    "Estimated Risk Reduction": "Medium",
    "Emergency Numbers to Call": {{"Police": "100", "Municipal": "1916"}}
  }}
]
"""

    payload = {
        "contents": [{"parts": [{"text": prompt}]}],
        "safetySettings": [
            {"category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE"},
            {"category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE"},
            {"category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE"},
            {"category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE"}
        ],
        "generationConfig": {
            "response_mime_type": "application/json",
            "temperature": 0,
            "topK": 1
        }
    }

    try:
        response = requests.post(url, headers=headers, json=payload, timeout=20)
        res_data = response.json()
        print(f"DEBUG FULL RESPONSE: {json.dumps(res_data, indent=2)}")  # Add for first test

        if "candidates" not in res_data or not res_data["candidates"]:
            error_msg = res_data.get("promptFeedback", {}).get("blockReason", "Unknown")
            print(f"üö´ Gemini Blocked: {error_msg}")
            print(f"SAFETY RATINGS: {res_data.get('promptFeedback', {}).get('safetyRatings', 'None')}")
            raise Exception(f"Blocked: {error_msg}")

        raw_text = res_data["candidates"][0]["content"]["parts"][0]["text"]
        clean_json = re.sub(r"```json|```", "", raw_text).strip()
        result = json.loads(clean_json)
        print(f"‚úÖ Gemini Success")
        return result

    except Exception as e:
        print(f"üí• Gemini Error: {str(e)}")
        raise e

# ==================== API ROUTES ====================
@app.post("/analyze")
def analyze_issue(data: IssueRequest):
    try:
        print(f"\nüìå API REQUEST: {data.issue_text}")
        ai_response = gemini_analysis(data.issue_text)
        print(f"‚úÖ RETURNING AI RESPONSE")
        return ai_response
    except Exception as e:
        print(f"‚ö†Ô∏è Gemini failed, using fallback: {str(e)}")
        fallback_response = rule_based_fallback(data.issue_text)
        print(f"‚úÖ RETURNING FALLBACK RESPONSE")
        return fallback_response


@app.get("/")
def root():
    return {"status": "AI Urban Hybrid Agent Running"}

@app.get("/models")
def list_models():
    url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key={GEMINI_API_KEY}"
    resp = requests.get(url)
    return resp.json()  # Yahan se sahi model name copy kar lo



@app.get("/health")
def health():
    return {
        "status": "healthy",
        "gemini_key_loaded": bool(GEMINI_API_KEY)
    }
